<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeju Agent Registry Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
        }

        .card-body {
            padding: 30px;
        }

        .network-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .network-option {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .network-option:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
        }

        .network-option.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .network-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .network-chain {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .agent-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-color: #4f46e5;
        }

        .agent-id {
            font-size: 2rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 10px;
        }

        .agent-owner {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 15px;
            font-family: monospace;
            word-break: break-all;
        }

        .agent-uri {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .agent-metadata {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .metadata-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #334155;
        }

        .metadata-item {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .metadata-item:last-child {
            border-bottom: none;
        }

        .metadata-key {
            font-weight: 600;
            color: #64748b;
            font-size: 0.85rem;
        }

        .metadata-value {
            color: #1e293b;
            margin-top: 4px;
            word-break: break-word;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .stat-label {
            color: #64748b;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .contract-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .contract-info strong {
            color: #4f46e5;
        }

        .refresh-btn {
            float: right;
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤– Jeju Agent Registry</h1>
            <p>ERC-8004 Trustless Agent Registry Viewer</p>
        </div>

        <div class="main-card">
            <div class="card-header">
                <h2>Select Network</h2>
            </div>
            <div class="card-body">
                <div class="network-selector" id="networkSelector">
                    <div class="network-option" data-network="localnet" data-chain="31337">
                        <div class="network-name">Localnet</div>
                        <div class="network-chain">Chain ID: 31337</div>
                    </div>
                    <div class="network-option" data-network="testnet" data-chain="16602">
                        <div class="network-name">Jeju Testnet</div>
                        <div class="network-chain">Chain ID: 16602</div>
                    </div>
                    <div class="network-option" data-network="mainnet" data-chain="919">
                        <div class="network-name">Jeju Mainnet</div>
                        <div class="network-chain">Chain ID: 919</div>
                    </div>
                </div>

                <div id="statusMessage" class="status"></div>

                <button id="connectBtn" class="btn">Connect Wallet</button>
                <button id="loadAgentsBtn" class="btn" style="display:none; margin-top: 10px;">Load Registered Agents</button>
            </div>
        </div>

        <div id="registryInfo" class="main-card" style="display:none;">
            <div class="card-header">
                <h2>Registry Information</h2>
                <button id="refreshBtn" class="btn refresh-btn">Refresh</button>
            </div>
            <div class="card-body">
                <div class="contract-info" id="contractInfo"></div>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>

        <div id="agentsContainer" class="main-card" style="display:none;">
            <div class="card-header">
                <h2>Registered Agents</h2>
            </div>
            <div class="card-body">
                <div id="agentsGrid" class="agents-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Network configurations
        const NETWORKS = {
            localnet: {
                rpcUrl: 'http://localhost:8545',
                chainId: 31337,
                name: 'Localnet'
            },
            testnet: {
                rpcUrl: 'https://rpc.testnet.jeju.network',
                chainId: 16602,
                name: 'Jeju Testnet'
            },
            mainnet: {
                rpcUrl: 'https://rpc.mainnet.jeju.network',
                chainId: 919,
                name: 'Jeju Mainnet'
            }
        };

        // Contract ABIs (minimal)
        const IDENTITY_REGISTRY_ABI = [
            "function totalAgents() view returns (uint256)",
            "function agentExists(uint256) view returns (bool)",
            "function ownerOf(uint256) view returns (address)",
            "function tokenURI(uint256) view returns (string)",
            "function getMetadata(uint256, string) view returns (bytes)",
            "function version() view returns (string)",
            "event Registered(uint256 indexed agentId, string tokenURI, address indexed owner)"
        ];

        let provider;
        let signer;
        let selectedNetwork = 'localnet';
        let contracts = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupNetworkSelector();
            setupButtons();
        });

        function setupNetworkSelector() {
            const options = document.querySelectorAll('.network-option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    options.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedNetwork = option.dataset.network;
                });
            });
            // Select localnet by default
            options[0].classList.add('selected');
        }

        function setupButtons() {
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('loadAgentsBtn').addEventListener('click', loadAgents);
            document.getElementById('refreshBtn')?.addEventListener('click', loadAgents);
        }

        async function connectWallet() {
            showStatus('Connecting to wallet...', 'info');
            
            try {
                if (!window.ethereum) {
                    throw new Error('Please install MetaMask or another Web3 wallet');
                }

                // Create provider and signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                const network = NETWORKS[selectedNetwork];
                
                // Try to switch to the selected network
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: `0x${network.chainId.toString(16)}` }],
                    });
                } catch (switchError) {
                    // Network doesn't exist, add it
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: `0x${network.chainId.toString(16)}`,
                                chainName: network.name,
                                rpcUrls: [network.rpcUrl],
                            }],
                        });
                    } else {
                        throw switchError;
                    }
                }

                // Load deployment addresses
                await loadDeploymentAddresses();
                
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('loadAgentsBtn').style.display = 'block';
                
                showStatus(`Connected to ${network.name}!`, 'success');
                
                // Auto-load agents
                await loadAgents();
                
            } catch (error) {
                console.error('Connection error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function loadDeploymentAddresses() {
            try {
                // Try to load from deployment file
                const response = await fetch(`../deployments/${selectedNetwork}/liquidity-system.json`);
                if (response.ok) {
                    const deployment = await response.json();
                    contracts.identityRegistry = deployment.identityRegistry;
                    contracts.reputationRegistry = deployment.reputationRegistry;
                    contracts.validationRegistry = deployment.validationRegistry;
                } else {
                    // Fallback: prompt user for addresses
                    contracts.identityRegistry = prompt('Enter IdentityRegistry address:', '');
                    if (!contracts.identityRegistry) {
                        throw new Error('IdentityRegistry address required');
                    }
                }
            } catch (error) {
                // Manual input fallback
                contracts.identityRegistry = prompt('Enter IdentityRegistry address:', '');
                if (!contracts.identityRegistry) {
                    throw new Error('IdentityRegistry address required');
                }
            }
        }

        async function loadAgents() {
            showStatus('Loading registered agents...', 'info');
            
            try {
                const registry = new ethers.Contract(
                    contracts.identityRegistry,
                    IDENTITY_REGISTRY_ABI,
                    provider
                );

                // Get total agents
                const totalAgents = await registry.totalAgents();
                
                // Get contract version
                const version = await registry.version();
                
                // Show registry info
                document.getElementById('registryInfo').style.display = 'block';
                document.getElementById('contractInfo').innerHTML = `
                    <strong>Contract:</strong> ${contracts.identityRegistry}<br>
                    <strong>Version:</strong> ${version}<br>
                    <strong>Network:</strong> ${NETWORKS[selectedNetwork].name}
                `;

                // Show stats
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalAgents}</div>
                        <div class="stat-label">Total Agents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${version}</div>
                        <div class="stat-label">Registry Version</div>
                    </div>
                `;

                if (totalAgents == 0) {
                    document.getElementById('agentsContainer').style.display = 'block';
                    document.getElementById('agentsGrid').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ“­</div>
                            <h3>No Agents Registered Yet</h3>
                            <p>Be the first to register an agent!</p>
                        </div>
                    `;
                    showStatus('No agents registered yet', 'info');
                    return;
                }

                // Load all agents
                const agents = [];
                for (let i = 1; i <= totalAgents; i++) {
                    try {
                        const exists = await registry.agentExists(i);
                        if (!exists) continue;

                        const owner = await registry.ownerOf(i);
                        const tokenURI = await registry.tokenURI(i);
                        
                        // Try to get some common metadata
                        let metadata = {};
                        const commonKeys = ['name', 'description', 'type', 'version', 'model', 'capabilities'];
                        for (const key of commonKeys) {
                            try {
                                const value = await registry.getMetadata(i, key);
                                if (value !== '0x') {
                                    metadata[key] = ethers.toUtf8String(ethers.AbiCoder.defaultAbiCoder().decode(['string'], value)[0]);
                                }
                            } catch (e) {
                                // Metadata key doesn't exist, skip
                            }
                        }
                        
                        agents.push({
                            id: i,
                            owner,
                            tokenURI,
                            metadata
                        });
                    } catch (error) {
                        console.error(`Error loading agent ${i}:`, error);
                    }
                }

                displayAgents(agents);
                showStatus(`Successfully loaded ${agents.length} agents!`, 'success');
                
            } catch (error) {
                console.error('Load error:', error);
                showStatus(`Error loading agents: ${error.message}`, 'error');
            }
        }

        function displayAgents(agents) {
            const grid = document.getElementById('agentsGrid');
            document.getElementById('agentsContainer').style.display = 'block';
            
            if (agents.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“­</div>
                        <h3>No Agents Found</h3>
                    </div>
                `;
                return;
            }

            grid.innerHTML = agents.map(agent => `
                <div class="agent-card">
                    <div class="agent-id">Agent #${agent.id}</div>
                    <div class="agent-owner">Owner: ${shortenAddress(agent.owner)}</div>
                    ${agent.tokenURI ? `<div class="agent-uri">ðŸ“„ ${agent.tokenURI}</div>` : ''}
                    
                    ${Object.keys(agent.metadata).length > 0 ? `
                        <div class="agent-metadata">
                            <div class="metadata-title">Metadata</div>
                            ${Object.entries(agent.metadata).map(([key, value]) => `
                                <div class="metadata-item">
                                    <div class="metadata-key">${key}</div>
                                    <div class="metadata-value">${value}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function shortenAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>

