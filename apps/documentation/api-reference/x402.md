# x402 Payments

HTTP-based micropayments using the x402 protocol.

## Overview

x402 enables pay-per-request APIs. The server returns 402 with payment requirements, the client signs an EIP-712 payment, the server verifies and executes the request, then payment is settled on-chain.

## Flow

The client makes a request, the server returns 402 with payment requirements, the client signs an EIP-712 payment, the client retries with the payment header, the server calls the Facilitator to verify and settle, the Facilitator confirms, and the server returns the response.

## Payment Requirements

When a server requires payment, it returns HTTP 402 with the `X-Payment-Requirements` header containing base64-encoded JSON. The payment requirements include scheme (`exact` for fixed or `upto` for max), network (`jeju`, `base-sepolia`, etc.), maxAmountRequired in token units, asset (token contract address), payTo (recipient address), and resource (API endpoint).

## Making Payments

### 1. Get Requirements

```typescript
const response = await fetch('https://compute.jeju.network/api/inference', {
  method: 'POST',
  body: JSON.stringify({ prompt: 'Hello' }),
});

if (response.status === 402) {
  const requirements = JSON.parse(
    atob(response.headers.get('X-Payment-Requirements'))
  );
}
```

### 2. Sign Payment

Create a payment object with scheme, network, amount, asset, payTo, validAfter, validBefore, and nonce. Sign it with EIP-712 typed data using domain name 'x402', version '1', and chain ID 420691.

### 3. Send with Payment

```typescript
const response = await fetch('https://compute.jeju.network/api/inference', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Payment': paymentHeader,
  },
  body: JSON.stringify({ prompt: 'Hello' }),
});
```

## Facilitator

The Facilitator service verifies and settles payments.

GET `/` returns health check. GET `/supported` returns supported networks. POST `/verify` verifies a payment. POST `/settle` settles on-chain.

### Verify Payment

Send x402Version, paymentHeader, and paymentRequirements. Response includes isValid, payer address, and amount.

### Settle Payment

Send the same payload as verify. Response includes success, txHash, settlementId, amount (with human, base, and symbol), and fee (with human, base, and bps).

## Supported Networks

Jeju (420691), Jeju Testnet (420690), Base Sepolia (84532), and Base (8453) are supported. USDC addresses vary by network.

## Server Implementation

Create middleware that checks for the `X-Payment` header. If missing, return 402 with requirements. If present, verify the payment, settle it if valid, then continue to the handler.

## Client Library

```typescript
import { X402Client } from '@jeju/x402-client';

const client = new X402Client({
  wallet,
  facilitatorUrl: 'https://facilitator.jeju.network',
});

// Automatically handles 402 and payment
const response = await client.fetch('https://compute.jeju.network/api/inference', {
  method: 'POST',
  body: JSON.stringify({ prompt: 'Hello' }),
});
```

## Fees

Protocol fee is 0.5% (50 bps). Gas is covered by the Facilitator.

## Error Codes

INVALID_SIGNATURE means bad payment signature. EXPIRED means payment expired. INSUFFICIENT_BALANCE means payer lacks funds. ALREADY_SETTLED means payment was already used. NETWORK_MISMATCH means wrong network.
