name: Deploy to AWS Testnet

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure after deployment (for testing)'
        required: false
        default: 'false'

permissions:
  id-token: write
  contents: read
  packages: write

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: testnet
  TERRAFORM_VERSION: 1.6.0
  HELM_VERSION: v3.13.0
  KUBECTL_VERSION: v1.28.0

jobs:
  # ============================================================
  # Job 1: Validate Configuration
  # ============================================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          MISSING_SECRETS=""
          
          # AWS Credentials
          if [ -z "${{ secrets.AWS_ROLE_ARN_TESTNET }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}AWS_ROLE_ARN_TESTNET "
          fi
          
          # Blockchain
          if [ -z "${{ secrets.DEPLOYER_PRIVATE_KEY_TESTNET }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}DEPLOYER_PRIVATE_KEY_TESTNET "
          fi
          
          # AI APIs (at least one required)
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ] && [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}OPENAI_API_KEY or ANTHROPIC_API_KEY "
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "❌ Missing required secrets: $MISSING_SECRETS"
            exit 1
          fi
          
          echo "✅ All required secrets configured"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install

      - name: Validate Terraform
        run: |
          cd terraform/environments/testnet
          terraform init -backend=false
          terraform validate

      - name: Validate Helm charts
        run: |
          helm lint kubernetes/helm/*/
          
      - name: Run tests
        run: bun test

  # ============================================================
  # Job 2: Build and Push Docker Images
  # ============================================================
  build-images:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    strategy:
      matrix:
        app: [bazaar, gateway, leaderboard, ipfs, documentation, crucible, ehorse]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TESTNET }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/jeju/${{ matrix.app }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=testnet-latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./apps/${{ matrix.app }}
          file: ./apps/${{ matrix.app }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================================
  # Job 3: Deploy Infrastructure (Terraform)
  # ============================================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: testnet-infrastructure
    outputs:
      eks-cluster-name: ${{ steps.terraform-output.outputs.eks_cluster_name }}
      rds-endpoint: ${{ steps.terraform-output.outputs.rds_endpoint }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TESTNET }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: terraform/environments/testnet
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform/environments/testnet
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: terraform/environments/testnet
        run: terraform apply -auto-approve tfplan

      - name: Extract Terraform Outputs
        id: terraform-output
        working-directory: terraform/environments/testnet
        run: |
          echo "eks_cluster_name=$(terraform output -raw eks_cluster_name)" >> $GITHUB_OUTPUT
          echo "rds_endpoint=$(terraform output -raw rds_endpoint)" >> $GITHUB_OUTPUT

  # ============================================================
  # Job 4: Deploy Smart Contracts
  # ============================================================
  deploy-contracts:
    name: Deploy Smart Contracts
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment:
      name: testnet-contracts
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: |
          cd contracts
          forge install
          
      - name: Deploy contracts
        working-directory: contracts
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY_TESTNET }}
          NETWORK: testnet
        run: |
          forge script script/DeployLiquiditySystem.s.sol:DeployLiquiditySystem \
            --rpc-url ${{ secrets.JEJU_TESTNET_RPC_URL }} \
            --broadcast \
            --verify \
            --etherscan-api-key ${{ secrets.BASESCAN_API_KEY }}

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: contract-deployments
          path: contracts/deployments/testnet/

  # ============================================================
  # Job 5: Deploy Applications to EKS
  # ============================================================
  deploy-apps:
    name: Deploy Applications
    runs-on: ubuntu-latest
    needs: [build-images, deploy-infrastructure, deploy-contracts]
    environment:
      name: testnet-apps
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TESTNET }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install Helmfile
        run: |
          wget https://github.com/helmfile/helmfile/releases/download/v0.157.0/helmfile_0.157.0_linux_amd64.tar.gz
          tar -xzf helmfile_0.157.0_linux_amd64.tar.gz
          sudo mv helmfile /usr/local/bin/
          helmfile version

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ${{ needs.deploy-infrastructure.outputs.eks-cluster-name }} \
            --region ${{ env.AWS_REGION }}

      - name: Download contract deployments
        uses: actions/download-artifact@v3
        with:
          name: contract-deployments
          path: contracts/deployments/testnet/

      - name: Create Kubernetes secrets
        run: |
          # Create namespace
          kubectl create namespace jeju-apps --dry-run=client -o yaml | kubectl apply -f -
          
          # Create app secrets from contract deployments
          kubectl create secret generic bazaar-env \
            --from-literal=NEXT_PUBLIC_NETWORK=testnet \
            --from-literal=NEXT_PUBLIC_CHAIN_ID=420690 \
            --from-literal=NEXT_PUBLIC_RPC_URL=${{ secrets.JEJU_TESTNET_RPC_URL }} \
            --from-file=contracts=contracts/deployments/testnet/liquidity-system.json \
            --namespace jeju-apps \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Leaderboard DB secret
          kubectl create secret generic leaderboard-db \
            --from-literal=DATABASE_URL=postgresql://leaderboard:${{ secrets.RDS_PASSWORD }}@${{ needs.deploy-infrastructure.outputs.rds-endpoint }}:5432/leaderboard \
            --namespace jeju-apps \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # AI API keys
          kubectl create secret generic ai-keys \
            --from-literal=OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            --from-literal=ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }} \
            --from-literal=OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }} \
            --namespace jeju-apps \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helmfile
        run: |
          cd kubernetes/helmfile
          helmfile -e testnet sync

      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/bazaar -n jeju-apps --timeout=10m
          kubectl rollout status deployment/gateway -n jeju-apps --timeout=10m
          kubectl rollout status deployment/leaderboard -n jeju-apps --timeout=10m

      - name: Run smoke tests
        run: |
          kubectl run smoke-test --rm -i --restart=Never \
            --image=curlimages/curl:latest \
            --namespace=jeju-apps \
            -- sh -c "
              echo 'Testing Bazaar...'
              curl -f http://bazaar.jeju-apps:4006/api/health || exit 1
              echo 'Testing Gateway...'
              curl -f http://gateway.jeju-apps/health || exit 1
              echo 'Testing Leaderboard...'
              curl -f http://leaderboard.jeju-apps:5012/api/health || exit 1
              echo 'All services healthy!'
            "

  # ============================================================
  # Job 6: Deploy Static Frontends to S3/CloudFront
  # ============================================================
  deploy-static:
    name: Deploy Static Frontends
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    
    strategy:
      matrix:
        app: [gateway, documentation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Build ${{ matrix.app }}
        working-directory: apps/${{ matrix.app }}
        run: |
          bun install
          bun run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TESTNET }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync to S3
        run: |
          aws s3 sync apps/${{ matrix.app }}/dist/ s3://jeju-testnet-${{ matrix.app }}/ \
            --delete \
            --cache-control max-age=31536000,public

      - name: Invalidate CloudFront
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='${{ matrix.app }} - testnet'].Id" \
            --output text)
          
          if [ -n "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
          fi

  # ============================================================
  # Job 7: Post-Deployment Verification
  # ============================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-apps, deploy-static]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Run verification tests
        env:
          JEJU_RPC_URL: ${{ secrets.JEJU_TESTNET_RPC_URL }}
        run: |
          bun run scripts/verify-cloud-deployment.ts

      - name: Health check all endpoints
        run: |
          ENDPOINTS=(
            "https://rpc.testnet.jeju.network"
            "https://bazaar.testnet.jeju.network"
            "https://gateway.testnet.jeju.network"
            "https://docs.testnet.jeju.network"
            "https://leaderboard.testnet.jeju.network"
            "https://indexer.testnet.jeju.network/health"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            echo "Checking $endpoint..."
            if curl -f -s "$endpoint" > /dev/null; then
              echo "✅ $endpoint is healthy"
            else
              echo "❌ $endpoint is DOWN"
              exit 1
            fi
          done

      - name: Send deployment notification
        if: success()
        run: |
          echo "✅ Testnet deployment successful!"
          echo "RPC: https://rpc.testnet.jeju.network"
          echo "Bazaar: https://bazaar.testnet.jeju.network"
          echo "Gateway: https://gateway.testnet.jeju.network"

  # ============================================================
  # Job 8: Cleanup (Optional - for testing)
  # ============================================================
  cleanup:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: verify
    if: ${{ github.event.inputs.destroy == 'true' }}
    environment:
      name: testnet-destroy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TESTNET }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Destroy Kubernetes resources
        run: |
          aws eks update-kubeconfig --name jeju-testnet-eks --region ${{ env.AWS_REGION }}
          helmfile -e testnet destroy

      - name: Destroy Terraform infrastructure
        working-directory: terraform/environments/testnet
        run: |
          terraform init
          terraform destroy -auto-approve

      - name: Verify cleanup
        run: |
          echo "✅ Testnet infrastructure destroyed"
          echo "Run workflow again to redeploy"

