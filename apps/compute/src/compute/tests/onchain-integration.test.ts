/**
 * On-Chain Integration Tests
 * 
 * Tests contract target execution, on-chain sync, and prepaid functions
 * against a local Anvil node. Skips gracefully if no node available.
 * 
 * Coverage:
 * - Contract target execution with/without args ✓
 * - Contract revert handling ✓
 * - Wallet requirement validation ✓
 * - Prepaid functions without registry (edge cases) ✓
 * - Sync without registry address (edge case) ✓
 * - Full TriggerRegistry integration (deposit, withdraw, record) ✓
 * - getCronTriggers from on-chain registry ✓
 */

import { describe, test, expect, beforeAll } from 'bun:test';
import { Wallet, JsonRpcProvider, Contract, ContractFactory, parseEther } from 'ethers';
import { createTriggerIntegration, type ContractTarget } from '../sdk/trigger-integration';
import type { Address } from 'viem';

const RPC_URL = process.env.JEJU_RPC_URL || 'http://127.0.0.1:8545';
// Anvil account 0
const ANVIL_PRIVATE_KEY = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';
// Anvil account 1 - for parallel tests to avoid nonce conflicts
const ANVIL_PRIVATE_KEY_2 = '0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d';

// Simple counter contract - compiled with forge
const COUNTER_ABI = [
  'function increment() public',
  'function incrementBy(uint256 n) public',
  'function count() public view returns (uint256)',
];
const COUNTER_BYTECODE = '0x6080604052348015600e575f5ffd5b506102258061001c5f395ff3fe608060405234801561000f575f5ffd5b506004361061003f575f3560e01c806303df179c1461004357806306661abd1461005f578063d09de08a1461007d575b5f5ffd5b61005d600480360381019061005891906100f5565b610087565b005b6100676100a1565b604051610074919061012f565b60405180910390f35b6100856100a6565b005b805f5f8282546100979190610175565b9250508190555050565b5f5481565b5f5f8154809291906100b7906101a8565b9190505550565b5f5ffd5b5f819050919050565b6100d4816100c2565b81146100de575f5ffd5b50565b5f813590506100ef816100cb565b92915050565b5f6020828403121561010a576101096100be565b5b5f610117848285016100e1565b91505092915050565b610129816100c2565b82525050565b5f6020820190506101425f830184610120565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61017f826100c2565b915061018a836100c2565b92508282019050808211156101a2576101a1610148565b5b92915050565b5f6101b2826100c2565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036101e4576101e3610148565b5b60018201905091905056fea2646970667358221220f0d704c46b635561390562b9cb4fbdde2021a115b03624997e8cc5e075e2dc2f64736f6c634300081e0033';

// SimpleTriggerRegistry - minimal registry for testing
const REGISTRY_ABI = [
  'function registerCronTrigger(string name, string cronExpression, string endpoint) returns (bytes32)',
  'function registerEventTrigger(string name, string endpoint) returns (bytes32)',
  'function setTriggerActive(bytes32 triggerId, bool active)',
  'function recordExecution(bytes32 triggerId, bool success, bytes32 outputHash) returns (bytes32)',
  'function depositPrepaid() payable',
  'function withdrawPrepaid(uint256 amount)',
  'function prepaidBalances(address) view returns (uint256)',
  'function getTrigger(bytes32) view returns (address owner, uint8 triggerType, string name, string endpoint, bool active, uint256 executionCount, uint256 lastExecutedAt, uint256 agentId)',
  'function getCronTriggers() view returns (bytes32[] triggerIds, string[] expressions, string[] endpoints)',
  'function getTriggerCount() view returns (uint256)',
];
const REGISTRY_BYTECODE = '0x6080604052348015600e575f5ffd5b5061264c8061001c5f395ff3fe6080604052600436106100c1575f3560e01c8063742cd89b1161007e578063bf335bba11610058578063bf335bba14610290578063c8c8aa72146102d3578063d2c21488146102ff578063fe63c87f14610327576100c1565b8063742cd89b1461022057806382e026081461024a578063b80ea96e14610254576100c1565b80630c894386146100c55780630e060e7d146101015780630ed9be8c1461013d578063353378f31461017957806340874c41146101bc578063566064a9146101f8575b5f5ffd5b3480156100d0575f5ffd5b506100eb60048036038101906100e6919061162e565b610363565b6040516100f8919061168d565b60405180910390f35b34801561010c575f5ffd5b5061012760048036038101906101229190611707565b6104cc565b604051610134919061168d565b60405180910390f35b348015610148575f5ffd5b50610163600480360381019061015e91906117ea565b61077d565b604051610170919061168d565b60405180910390f35b348015610184575f5ffd5b5061019f600480360381019061019a9190611815565b61079d565b6040516101b3989796959493929190611980565b60405180910390f35b3480156101c7575f5ffd5b506101e260048036038101906101dd9190611a0a565b610923565b6040516101ef919061168d565b60405180910390f35b348015610203575f5ffd5b5061021e60048036038101906102199190611a88565b610bb1565b005b34801561022b575f5ffd5b50610234610c7e565b6040516102419190611ac6565b60405180910390f35b610252610c8a565b005b34801561025f575f5ffd5b5061027a60048036038101906102759190611815565b610d6f565b6040516102879190611adf565b60405180910390f35b34801561029b575f5ffd5b506102b660048036038101906102b19190611815565b610e0a565b6040516102ca989796959493929190611980565b60405180910390f35b3480156102de575f5ffd5b506102e7610fb2565b6040516102f693929190611cb9565b60405180910390f35b34801561030a575f5ffd5b50610325600480360381019061032091906117ea565b6113dc565b005b348015610332575f5ffd5b5061034d60048036038101906103489190611d2d565b6115a9565b60405161035a9190611ac6565b60405180910390f35b5f5f73ffffffffffffffffffffffffffffffffffffffff165f5f8681526020019081526020015f205f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1603610403576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103fa90611da2565b60405180910390fd5b5f84334260405160200161041993929190611e45565b604051602081830303815290604052805190602001209050425f5f8781526020019081526020015f20600501819055505f5f8681526020019081526020015f206004015f81548092919061046c90611eae565b91905055503373ffffffffffffffffffffffffffffffffffffffff1681867f2d57880a151664eac053e30d578bb85717cb9423f48b9de2ffc90e2ee415f6c2876040516104b99190611ef5565b60405180910390a4809150509392505050565b5f5f338888426040516020016104e59493929190611f4a565b6040516020818303038152906040528051906020012090506040518061010001604052803373ffffffffffffffffffffffffffffffffffffffff1681526020015f60028111156105385761053761187f565b5b815260200189898080601f0160208091040260200160405190810160405280939291908181526020018383808284375f81840152601f19601f82011690508083019250505050505050815260200185858080601f0160208091040260200160405190810160405280939291908181526020018383808284375f81840152601f19601f8201169050808301925050505050505081526020016001151581526020015f81526020015f81526020015f8152505f5f8381526020019081526020015f205f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151815f0160146101000a81548160ff021916908360028111156106665761066561187f565b5b0217905550604082015181600101908161068091906121ae565b50606082015181600201908161069691906121ae565b506080820151816003015f6101000a81548160ff02191690831515021790555060a0820151816004015560c0820151816005015560e08201518160060155905050858560035f8481526020019081526020015f2091826106f7929190612287565b50600281908060018154018082558091505060019003905f5260205f20015f90919091909150553373ffffffffffffffffffffffffffffffffffffffff16817fcde6869c46996301faca2af52f0c286df02219d7d7fec1869b49444c2a5e549a8a8a604051610767929190612380565b60405180910390a3809150509695505050505050565b6002818154811061078c575f80fd5b905f5260205f20015f915090505481565b5f602052805f5260405f205f91509050805f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690805f0160149054906101000a900460ff16908060010180546107f290611fde565b80601f016020809104026020016040519081016040528092919081815260200182805461081e90611fde565b80156108695780601f1061084057610100808354040283529160200191610869565b820191905f5260205f20905b81548152906001019060200180831161084c57829003601f168201915b50505050509080600201805461087e90611fde565b80601f01602080910402602001604051908101604052809291908181526020018280546108aa90611fde565b80156108f55780601f106108cc576101008083540402835291602001916108f5565b820191905f5260205f20905b8154815290600101906020018083116108d857829003601f168201915b505050505090806003015f9054906101000a900460ff16908060040154908060050154908060060154905088565b5f5f3386864260405160200161093c9493929190611f4a565b6040516020818303038152906040528051906020012090506040518061010001604052803373ffffffffffffffffffffffffffffffffffffffff16815260200160028081111561098f5761098e61187f565b5b815260200187878080601f0160208091040260200160405190810160405280939291908181526020018383808284375f81840152601f19601f82011690508083019250505050505050815260200185858080601f0160208091040260200160405190810160405280939291908181526020018383808284375f81840152601f19601f8201169050808301925050505050505081526020016001151581526020015f81526020015f81526020015f8152505f5f8381526020019081526020015f205f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151815f0160146101000a81548160ff02191690836002811115610abd57610abc61187f565b5b02179055506040820151816001019081610ad791906121ae565b506060820151816002019081610aed91906121ae565b506080820151816003015f6101000a81548160ff02191690831515021790555060a0820151816004015560c0820151816005015560e08201518160060155905050600281908060018154018082558091505060019003905f5260205f20015f90919091909150553373ffffffffffffffffffffffffffffffffffffffff16817fcde6869c46996301faca2af52f0c286df02219d7d7fec1869b49444c2a5e549a8888604051610b9d929190612380565b60405180910390a380915050949350505050565b3373ffffffffffffffffffffffffffffffffffffffff165f5f8481526020019081526020015f205f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610c50576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c47906123ec565b60405180910390fd5b805f5f8481526020019081526020015f206003015f6101000a81548160ff0219169083151502179055505050565b5f600280549050905090565b5f3411610ccc576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cc390612454565b60405180910390fd5b3460015f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f828254610d189190612472565b925050819055503373ffffffffffffffffffffffffffffffffffffffff167f235b3e4e963772af8b5b7f640b408e6402db0ed7efb9e31d1998df158ce9a05934604051610d659190611ac6565b60405180910390a2565b6003602052805f5260405f205f915090508054610d8b90611fde565b80601f0160208091040260200160405190810160405280929190818152602001828054610db790611fde565b8015610e025780601f10610dd957610100808354040283529160200191610e02565b820191905f5260205f20905b815481529060010190602001808311610de557829003601f168201915b505050505081565b5f5f6060805f5f5f5f5f5f5f8b81526020019081526020015f209050805f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16815f0160149054906101000a900460ff168260010183600201846003015f9054906101000a900460ff16856004015486600501548760060154858054610e8e90611fde565b80601f0160208091040260200160405190810160405280929190818152602001828054610eba90611fde565b8015610f055780601f10610edc57610100808354040283529160200191610f05565b820191905f5260205f20905b815481529060010190602001808311610ee857829003601f168201915b50505050509550848054610f1890611fde565b80601f0160208091040260200160405190810160405280929190818152602001828054610f4490611fde565b8015610f8f5780601f10610f6657610100808354040283529160200191610f8f565b820191905f5260205f20905b815481529060010190602001808311610f7257829003601f168201915b505050505094509850985098509850985098509850985050919395975091939597565b60608060605f5f90505f5f90505b600280549050811015611094575f5f60028381548110610fe357610fe26124a5565b5b905f5260205f20015481526020019081526020015f206003015f9054906101000a900460ff16801561107357505f60028111156110235761102261187f565b5b5f5f60028481548110611039576110386124a5565b5b905f5260205f20015481526020019081526020015f205f0160149054906101000a900460ff1660028111156110715761107061187f565b5b145b1561108757818061108390611eae565b9250505b8080600101915050610fc0565b508067ffffffffffffffff8111156110af576110ae611f84565b5b6040519080825280602002602001820160405280156110dd5781602001602082028036833780820191505090505b5093508067ffffffffffffffff8111156110fa576110f9611f84565b5b60405190808252806020026020018201604052801561112d57816020015b60608152602001906001900390816111185790505b5092508067ffffffffffffffff81111561114a57611149611f84565b5b60405190808252806020026020018201604052801561117d57816020015b60608152602001906001900390816111685790505b5091505f5f90505f5f90505b6002805490508110156113d4575f600282815481106111ab576111aa6124a5565b5b905f5260205f20015490505f5f8281526020019081526020015f206003015f9054906101000a900460ff16801561122457505f60028111156111f0576111ef61187f565b5b5f5f8381526020019081526020015f205f0160149054906101000a900460ff1660028111156112225761122161187f565b5b145b156113c6578087848151811061123d5761123c6124a5565b5b60200260200101818152505060035f8281526020019081526020015f20805461126590611fde565b80601f016020809104026020016040519081016040528092919081815260200182805461129190611fde565b80156112dc5780601f106112b3576101008083540402835291602001916112dc565b820191905f5260205f20905b8154815290600101906020018083116112bf57829003601f168201915b50505050508684815181106112f4576112f36124a5565b5b60200260200101819052505f5f8281526020019081526020015f20600201805461131d90611fde565b80601f016020809104026020016040519081016040528092919081815260200182805461134990611fde565b80156113945780601f1061136b57610100808354040283529160200191611394565b820191905f5260205f20905b81548152906001019060200180831161137757829003601f168201915b50505050508584815181106113ac576113ab6124a5565b5b602002602001018190525082806113c290611eae565b9350505b508080600101915050611189565b505050909192565b8060015f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054101561145c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114539061251c565b60405180910390fd5b8060015f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546114a8919061253a565b925050819055505f3373ffffffffffffffffffffffffffffffffffffffff16826040516114d49061259a565b5f6040518083038185875af1925050503d805f811461150e576040519150601f19603f3d011682016040523d82523d5f602084013e611513565b606091505b5050905080611557576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161154e906125f8565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff167f0553a6eae5963fb706b6523e01f6a03bad3a189b3ddec929e05d67e513b0ed7b8360405161159d9190611ac6565b60405180910390a25050565b6001602052805f5260405f205f915090505481565b5f5ffd5b5f5ffd5b5f819050919050565b6115d8816115c6565b81146115e2575f5ffd5b50565b5f813590506115f3816115cf565b92915050565b5f8115159050919050565b61160d816115f9565b8114611617575f5ffd5b50565b5f8135905061162881611604565b92915050565b5f5f5f60608486031215611645576116446115be565b5b5f611652868287016115e5565b93505060206116638682870161161a565b9250506040611674868287016115e5565b9150509250925092565b611687816115c6565b82525050565b5f6020820190506116a05f83018461167e565b92915050565b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83601f8401126116c7576116c66116a6565b5b8235905067ffffffffffffffff8111156116e4576116e36116aa565b5b602083019150836001820283011115611700576116ff6116ae565b5b9250929050565b5f5f5f5f5f5f60608789031215611721576117206115be565b5b5f87013567ffffffffffffffff81111561173e5761173d6115c2565b5b61174a89828a016116b2565b9650965050602087013567ffffffffffffffff81111561176d5761176c6115c2565b5b61177989828a016116b2565b9450945050604087013567ffffffffffffffff81111561179c5761179b6115c2565b5b6117a889828a016116b2565b92509250509295509295509295565b5f819050919050565b6117c9816117b7565b81146117d3575f5ffd5b50565b5f813590506117e4816117c0565b92915050565b5f602082840312156117ff576117fe6115be565b5b5f61180c848285016117d6565b91505092915050565b5f6020828403121561182a576118296115be565b5b5f611837848285016115e5565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61186982611840565b9050919050565b6118798161185f565b82525050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffd5b600381106118bd576118bc61187f565b5b50565b5f8190506118cd826118ac565b919050565b5f6118dc826118c0565b9050919050565b6118ec816118d2565b82525050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f611934826118f2565b61193e81856118fc565b935061194e81856020860161190c565b6119578161191a565b840191505092915050565b61196b816115f9565b82525050565b61197a816117b7565b82525050565b5f610100820190506119945f83018b611870565b6119a1602083018a6118e3565b81810360408301526119b3818961192a565b905081810360608301526119c7818861192a565b90506119d66080830187611962565b6119e360a0830186611971565b6119f060c0830185611971565b6119fd60e0830184611971565b9998505050505050505050565b5f5f5f5f60408587031215611a2257611a216115be565b5b5f85013567ffffffffffffffff811115611a3f57611a3e6115c2565b5b611a4b878288016116b2565b9450945050602085013567ffffffffffffffff811115611a6e57611a6d6115c2565b5b611a7a878288016116b2565b925092505092959194509250565b5f5f60408385031215611a9e57611a9d6115be565b5b5f611aab858286016115e5565b9250506020611abc8582860161161a565b9150509250929050565b5f602082019050611ad95f830184611971565b92915050565b5f6020820190508181035f830152611af7818461192a565b905092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b611b31816115c6565b82525050565b5f611b428383611b28565b60208301905092915050565b5f602082019050919050565b5f611b6482611aff565b611b6e8185611b09565b9350611b7983611b19565b805f5b83811015611ba9578151611b908882611b37565b9750611b9b83611b4e565b925050600181019050611b7c565b5085935050505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f82825260208201905092915050565b5f611bf9826118f2565b611c038185611bdf565b9350611c1381856020860161190c565b611c1c8161191a565b840191505092915050565b5f611c328383611bef565b905092915050565b5f602082019050919050565b5f611c5082611bb6565b611c5a8185611bc0565b935083602082028501611c6c85611bd0565b805f5b85811015611ca75784840389528151611c888582611c27565b9450611c9383611c3a565b925060208a01995050600181019050611c6f565b50829750879550505050505092915050565b5f6060820190508181035f830152611cd18186611b5a565b90508181036020830152611ce58185611c46565b90508181036040830152611cf98184611c46565b9050949350505050565b611d0c8161185f565b8114611d16575f5ffd5b50565b5f81359050611d2781611d03565b92915050565b5f60208284031215611d4257611d416115be565b5b5f611d4f84828501611d19565b91505092915050565b7f54726967676572206e6f7420666f756e640000000000000000000000000000005f82015250565b5f611d8c6011836118fc565b9150611d9782611d58565b602082019050919050565b5f6020820190508181035f830152611db981611d80565b9050919050565b5f819050919050565b611dda611dd5826115c6565b611dc0565b82525050565b5f8160601b9050919050565b5f611df682611de0565b9050919050565b5f611e0782611dec565b9050919050565b611e1f611e1a8261185f565b611dfd565b82525050565b5f819050919050565b611e3f611e3a826117b7565b611e25565b82525050565b5f611e508286611dc9565b602082019150611e608285611e0e565b601482019150611e708284611e2e565b602082019150819050949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f611eb8826117b7565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611eea57611ee9611e81565b5b600182019050919050565b5f602082019050611f085f830184611962565b92915050565b5f81905092915050565b828183375f83830152505050565b5f611f318385611f0e565b9350611f3e838584611f18565b82840190509392505050565b5f611f558287611e0e565b601482019150611f66828587611f26565b9150611f728284611e2e565b60208201915081905095945050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680611ff557607f821691505b60208210810361200857612007611fb1565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f6008830261206a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261202f565b612074868361202f565b95508019841693508086168417925050509392505050565b5f819050919050565b5f6120af6120aa6120a5846117b7565b61208c565b6117b7565b9050919050565b5f819050919050565b6120c883612095565b6120dc6120d4826120b6565b84845461203b565b825550505050565b5f5f905090565b6120f36120e4565b6120fe8184846120bf565b505050565b5b81811015612121576121165f826120eb565b600181019050612104565b5050565b601f821115612166576121378161200e565b61214084612020565b8101602085101561214f578190505b61216361215b85612020565b830182612103565b50505b505050565b5f82821c905092915050565b5f6121865f198460080261216b565b1980831691505092915050565b5f61219e8383612177565b9150826002028217905092915050565b6121b7826118f2565b67ffffffffffffffff8111156121d0576121cf611f84565b5b6121da8254611fde565b6121e5828285612125565b5f60209050601f831160018114612216575f8415612204578287015190505b61220e8582612193565b865550612275565b601f1984166122248661200e565b5f5b8281101561224b57848901518255600182019150602085019450602081019050612226565b868310156122685784890151612264601f891682612177565b8355505b6001600288020188555050505b505050505050565b5f82905092915050565b612291838361227d565b67ffffffffffffffff8111156122aa576122a9611f84565b5b6122b48254611fde565b6122bf828285612125565b5f601f8311600181146122ec575f84156122da578287013590505b6122e48582612193565b86555061234b565b601f1984166122fa8661200e565b5f5b82811015612321578489013582556001820191506020850194506020810190506122fc565b8683101561233e578489013561233a601f891682612177565b8355505b6001600288020188555050505b50505050505050565b5f61235f83856118fc565b935061236c838584611f18565b6123758361191a565b840190509392505050565b5f6020820190508181035f830152612399818486612354565b90509392505050565b7f4e6f74206f776e657200000000000000000000000000000000000000000000005f82015250565b5f6123d66009836118fc565b91506123e1826123a2565b602082019050919050565b5f6020820190508181035f830152612403816123ca565b9050919050565b7f4e6f2076616c75650000000000000000000000000000000000000000000000005f82015250565b5f61243e6008836118fc565b91506124498261240a565b602082019050919050565b5f6020820190508181035f83015261246b81612432565b9050919050565b5f61247c826117b7565b9150612487836117b7565b925082820190508082111561249f5761249e611e81565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b7f496e73756666696369656e742062616c616e63650000000000000000000000005f82015250565b5f6125066014836118fc565b9150612511826124d2565b602082019050919050565b5f6020820190508181035f830152612533816124fa565b9050919050565b5f612544826117b7565b915061254f836117b7565b925082820390508181111561256757612566611e81565b5b92915050565b5f81905092915050565b50565b5f6125855f8361256d565b915061259082612577565b5f82019050919050565b5f6125a48261257a565b9150819050919050565b7f5472616e73666572206661696c656400000000000000000000000000000000005f82015250565b5f6125e2600f836118fc565b91506125ed826125ae565b602082019050919050565b5f6020820190508181035f83015261260f816125d6565b905091905056fea26469706673582212203807aeeea26e4fd445a0f0643c3f2371f120e8e1e032c8d0230228d2c278788f64736f6c634300081e0033';

let networkAvailable = false;
let counterAddress: string;
let registryAddress: string;

async function checkNetwork(): Promise<boolean> {
  try {
    const provider = new JsonRpcProvider(RPC_URL);
    await provider.getBlockNumber();
    return true;
  } catch {
    return false;
  }
}

async function deployContract(abi: string[], bytecode: string): Promise<string> {
  // Create fresh provider/wallet to avoid nonce caching issues
  const freshProvider = new JsonRpcProvider(RPC_URL);
  const freshWallet = new Wallet(ANVIL_PRIVATE_KEY, freshProvider);
  const factory = new ContractFactory(abi, bytecode, freshWallet);
  const contract = await factory.deploy();
  await contract.waitForDeployment();
  return await contract.getAddress();
}

describe('On-Chain Integration', () => {
  beforeAll(async () => {
    networkAvailable = await checkNetwork();
    if (networkAvailable) {
      // Deploy sequentially with fresh wallet instances to avoid nonce conflicts
      counterAddress = await deployContract(COUNTER_ABI, COUNTER_BYTECODE);
      console.log('[Test] Counter deployed at', counterAddress);
      registryAddress = await deployContract(REGISTRY_ABI, REGISTRY_BYTECODE);
      console.log('[Test] Registry deployed at', registryAddress);
    } else {
      console.log('[Test] Skipping on-chain tests - no local node at', RPC_URL);
    }
  });

  // Contract Target tests - consolidated to avoid nonce conflicts
  test('Contract Targets: execute, dynamic args, no wallet, revert', async () => {
    if (!networkAvailable) { console.log('   Skipping: no network'); return; }

    // Create fresh wallet for contract tests
    const freshProvider = new JsonRpcProvider(RPC_URL);
    const freshWallet = new Wallet(ANVIL_PRIVATE_KEY, freshProvider);

    const integration = createTriggerIntegration({
      rpcUrl: RPC_URL,
      enableOnChainRegistration: false,
      executorWallet: freshWallet,
      chainId: 31337,
    });
    await integration.initialize();

    // 1. Execute contract target with no args
    const triggerId1 = await integration.registerTrigger({
      source: 'local',
      type: 'event',
      name: 'increment-counter',
      eventTypes: ['increment'],
      target: {
        type: 'contract',
        address: counterAddress as Address,
        functionName: 'increment',
        abi: 'function increment() public',
      } as ContractTarget,
      active: true,
    });

    const counter = new Contract(counterAddress, COUNTER_ABI, freshProvider);
    const countBefore = await counter.count();

    const result1 = await integration.executeTrigger({ triggerId: triggerId1 });
    expect(result1.status).toBe('success');
    expect(result1.output).toBeDefined();
    expect(result1.output!.txHash).toMatch(/^0x[a-f0-9]{64}$/);
    expect(result1.output!.blockNumber).toBeGreaterThan(0);

    const countAfter1 = await counter.count();
    expect(countAfter1).toBe(countBefore + 1n);
    console.log('[Test] Contract increment works');

    // 2. Execute with dynamic args
    const triggerId2 = await integration.registerTrigger({
      source: 'local',
      type: 'event',
      name: 'increment-by',
      eventTypes: ['increment-by'],
      target: {
        type: 'contract',
        address: counterAddress as Address,
        functionName: 'incrementBy',
        abi: 'function incrementBy(uint256 n) public',
        args: ['{{n}}'],
      } as ContractTarget,
      active: true,
    });

    const countBefore2 = await counter.count();
    const result2 = await integration.executeTrigger({
      triggerId: triggerId2,
      input: { n: 5 },
    });
    expect(result2.status).toBe('success');
    expect(result2.output!.txHash).toMatch(/^0x[a-f0-9]{64}$/);

    const countAfter2 = await counter.count();
    expect(countAfter2).toBe(countBefore2 + 5n);
    console.log('[Test] Contract incrementBy works');

    // 3. Fails without executor wallet
    const noWalletIntegration = createTriggerIntegration({
      rpcUrl: RPC_URL,
      enableOnChainRegistration: false,
      chainId: 31337,
    });
    await noWalletIntegration.initialize();

    const triggerIdNoWallet = await noWalletIntegration.registerTrigger({
      source: 'local',
      type: 'event',
      name: 'will-fail',
      eventTypes: ['fail'],
      target: {
        type: 'contract',
        address: counterAddress as Address,
        functionName: 'increment',
        abi: 'function increment() public',
      } as ContractTarget,
      active: true,
    });

    await expect(noWalletIntegration.executeTrigger({ triggerId: triggerIdNoWallet }))
      .rejects.toThrow('Wallet required for contract calls');
    await noWalletIntegration.shutdown();
    console.log('[Test] No wallet check works');

    // 4. Handles contract revert
    const triggerIdRevert = await integration.registerTrigger({
      source: 'local',
      type: 'event',
      name: 'will-revert',
      eventTypes: ['revert'],
      target: {
        type: 'contract',
        address: counterAddress as Address,
        functionName: 'nonExistentFunction',
        abi: 'function nonExistentFunction() public',
      } as ContractTarget,
      active: true,
    });

    await expect(integration.executeTrigger({ triggerId: triggerIdRevert })).rejects.toThrow();
    console.log('[Test] Contract revert handling works');

    await integration.shutdown();
  });

  // Prepaid Balance tests - no on-chain transactions, safe to run in parallel
  test('getPrepaidBalance returns 0n without registry', async () => {
    const integration = createTriggerIntegration({
      rpcUrl: RPC_URL,
      enableOnChainRegistration: false,
      chainId: 31337,
    });
    await integration.initialize();
    const balance = await integration.getPrepaidBalance('0x1234567890123456789012345678901234567890' as Address);
    expect(balance).toBe(0n);
    await integration.shutdown();
  });

  test('depositPrepaid throws without registry', async () => {
    // No actual tx sent, just testing error before registry is set
    const integration = createTriggerIntegration({
      rpcUrl: RPC_URL,
      enableOnChainRegistration: false,
      chainId: 31337,
    });
    await integration.initialize();
    await expect(integration.depositPrepaid(1000n))
      .rejects.toThrow('Registry and wallet required');
    await integration.shutdown();
  });

  test('withdrawPrepaid throws without registry', async () => {
    // No actual tx sent, just testing error before registry is set
    const integration = createTriggerIntegration({
      rpcUrl: RPC_URL,
      enableOnChainRegistration: false,
      chainId: 31337,
    });
    await integration.initialize();
    await expect(integration.withdrawPrepaid(1000n))
      .rejects.toThrow('Registry and wallet required');
    await integration.shutdown();
  });

  describe('On-Chain Sync', () => {
    test('syncFromOnChain skips without registry address', async () => {
      const integration = createTriggerIntegration({
        rpcUrl: RPC_URL,
        enableOnChainRegistration: true,
        chainId: 31337,
      });

      // Should not throw, just skip
      await integration.initialize();
      expect(integration.getTriggers()).toHaveLength(0);

      await integration.shutdown();
    });
  });

  // Sequential registry tests - uses different Anvil account to avoid nonce conflicts
  test('Full Registry: deposit, withdraw, register, execute, deactivate', async () => {
    if (!networkAvailable) { console.log('   Skipping: no network'); return; }

    // Use second Anvil account to avoid nonce conflicts with contract tests
    // IMPORTANT: Create new provider/wallet for each transaction block to avoid ethers nonce caching
    const getWallet = () => {
      const p = new JsonRpcProvider(RPC_URL);
      return new Wallet(ANVIL_PRIVATE_KEY_2, p);
    };

    const freshWallet = getWallet();
    const registry = new Contract(registryAddress, REGISTRY_ABI, freshWallet);

    // 1. Test deposit and withdraw prepaid balance
    const initialBalance = await registry.prepaidBalances(freshWallet.address);
    expect(initialBalance).toBe(0n);

    const depositAmount = parseEther('0.1');
    const depositTx = await registry.depositPrepaid({ value: depositAmount });
    await depositTx.wait();
    console.log('[Test] Deposit tx confirmed');

    const afterDeposit = await registry.prepaidBalances(freshWallet.address);
    expect(afterDeposit).toBe(depositAmount);

    // Fresh wallet instance to get correct nonce from chain
    const wallet2 = getWallet();
    const registry2 = new Contract(registryAddress, REGISTRY_ABI, wallet2);
    const withdrawAmount = parseEther('0.05');
    const withdrawTx = await registry2.withdrawPrepaid(withdrawAmount);
    await withdrawTx.wait();

    const afterWithdraw = await registry.prepaidBalances(freshWallet.address);
    expect(afterWithdraw).toBe(depositAmount - withdrawAmount);
    console.log('[Test] Prepaid deposit/withdraw works');

    // 2. Test register and query cron trigger - fresh wallet for new nonce
    const wallet3 = getWallet();
    const registry3 = new Contract(registryAddress, REGISTRY_ABI, wallet3);
    const cronTx = await registry3.registerCronTrigger(
      'test-cron',
      '*/5 * * * *',
      'http://example.com/trigger'
    );
    const cronReceipt = await cronTx.wait();
    expect(cronReceipt.status).toBe(1);

    const count = await registry.getTriggerCount();
    expect(count).toBeGreaterThan(0n);

    const [triggerIds, expressions] = await registry.getCronTriggers();
    expect(triggerIds.length).toBeGreaterThan(0);
    expect(expressions).toContain('*/5 * * * *');
    console.log('[Test] Cron trigger registration works');

    // 3. Test record execution - fresh wallet
    const wallet4 = getWallet();
    const registry4 = new Contract(registryAddress, REGISTRY_ABI, wallet4);
    const execRegTx = await registry4.registerCronTrigger(
      'execution-test',
      '0 * * * *',
      'http://example.com/exec'
    );
    const execRegReceipt = await execRegTx.wait();
    const execTriggerId = execRegReceipt.logs[0].topics[1];

    const beforeExec = await registry.getTrigger(execTriggerId);
    const execCountBefore = beforeExec[5];

    // Fresh wallet for recordExecution
    const wallet5 = getWallet();
    const registry5 = new Contract(registryAddress, REGISTRY_ABI, wallet5);
    const outputHash = '0x' + '1'.repeat(64);
    const execTx = await registry5.recordExecution(execTriggerId, true, outputHash);
    await execTx.wait();

    const afterExec = await registry.getTrigger(execTriggerId);
    expect(afterExec[5]).toBe(execCountBefore + 1n);
    expect(afterExec[6]).toBeGreaterThan(0n);
    console.log('[Test] Execution recording works');

    // 4. Test deactivate trigger - fresh wallet
    const wallet6 = getWallet();
    const registry6 = new Contract(registryAddress, REGISTRY_ABI, wallet6);
    const deactRegTx = await registry6.registerEventTrigger(
      'deactivate-test',
      'http://example.com/deactivate'
    );
    const deactReceipt = await deactRegTx.wait();
    const deactTriggerId = deactReceipt.logs[0].topics[1];

    const beforeDeactivate = await registry.getTrigger(deactTriggerId);
    expect(beforeDeactivate[4]).toBe(true);

    // Fresh wallet for deactivation
    const wallet7 = getWallet();
    const registry7 = new Contract(registryAddress, REGISTRY_ABI, wallet7);
    const deactivateTx = await registry7.setTriggerActive(deactTriggerId, false);
    await deactivateTx.wait();

    const afterDeactivate = await registry.getTrigger(deactTriggerId);
    expect(afterDeactivate[4]).toBe(false);
    console.log('[Test] Trigger deactivation works');
  });
});
