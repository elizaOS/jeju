# Alertmanager - Alert Routing and Notification
# Routes Prometheus alerts to PagerDuty, Slack, etc.

replicaCount: 2

image:
  repository: prom/alertmanager
  pullPolicy: IfNotPresent
  tag: "v0.27.0"

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

service:
  type: ClusterIP
  port: 9093
  clusterPort: 9094

ingress:
  enabled: false

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

persistence:
  enabled: true
  storageClass: "gp3"
  accessMode: ReadWriteOnce
  size: 5Gi

nodeSelector: {}
tolerations: []
affinity: {}

# Secrets configuration - REQUIRED for production
# Set these via --set or values file, NOT in git
secrets:
  create: true
  # These must be provided at deploy time:
  # helm upgrade --set secrets.slackWebhookUrl=$SLACK_WEBHOOK_URL
  slackWebhookUrl: ""
  pagerdutyServiceKey: ""

# Environment variable references for secret injection
secretEnv:
  - name: SLACK_WEBHOOK_URL
    valueFrom:
      secretKeyRef:
        name: alertmanager-credentials
        key: slack-webhook-url
        optional: true
  - name: PAGERDUTY_SERVICE_KEY
    valueFrom:
      secretKeyRef:
        name: alertmanager-credentials
        key: pagerduty-service-key
        optional: true

config:
  global:
    resolve_timeout: 5m
    
  route:
    group_by: ['alertname', 'severity']
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h
    receiver: 'default'
    routes:
      - match:
          severity: critical
        receiver: 'pagerduty-critical'
        continue: true
      - match:
          severity: warning
        receiver: 'slack-warning'
      - match:
          category: chain
        receiver: 'slack-chain'
  
  receivers:
    - name: 'default'
      slack_configs:
        - api_url_file: /etc/alertmanager/secrets/slack-webhook-url
          channel: '#alerts'
          send_resolved: true
    
    - name: 'pagerduty-critical'
      pagerduty_configs:
        - service_key_file: /etc/alertmanager/secrets/pagerduty-service-key
          severity: critical
          description: '{{ .CommonAnnotations.summary }}'
    
    - name: 'slack-warning'
      slack_configs:
        - api_url_file: /etc/alertmanager/secrets/slack-webhook-url
          channel: '#alerts-warning'
          send_resolved: true
          
    - name: 'slack-chain'
      slack_configs:
        - api_url_file: /etc/alertmanager/secrets/slack-webhook-url
          channel: '#chain-health'
          send_resolved: true
          
  inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname']




