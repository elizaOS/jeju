name: "Setup Leaderboard Pipeline Data Branch"
description: "Sets up a worktree for the pipeline-data branch and syncs data"
inputs:
  operation:
    description: "Operation to perform: setup, update, or cleanup"
    required: true
  data_dir:
    description: "Directory containing data files to sync (relative to apps/leaderboard)"
    required: false
    default: "data"
  exclude_pattern:
    description: "Pattern to exclude when copying files"
    required: false
    default: "*.sqlite"
  commit_message:
    description: "Commit message for updates"
    required: false
    default: 'Pipeline run: $(date -u +"%Y-%m-%d %H:%M")'
  branch_name:
    description: "Name of the branch to store pipeline data"
    required: false
    default: "leaderboard-data"

runs:
  using: "composite"
  steps:
    - name: Setup pipeline-data branch
      if: inputs.operation == 'setup'
      shell: bash
      working-directory: apps/leaderboard
      run: |
        set -e
        mkdir -p ${{ inputs.data_dir }}
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

        if git ls-remote --heads origin ${{ inputs.branch_name }} | grep ${{ inputs.branch_name }}; then
          echo "Pipeline data branch exists, retrieving data..."
          git fetch origin ${{ inputs.branch_name }}
          git worktree add .pipeline-data-worktree origin/${{ inputs.branch_name }}
          echo "Copying all data files from worktree to workspace..."
          rsync -av .pipeline-data-worktree/data/ ${{ inputs.data_dir }}/
        else
          echo "Creating new pipeline-data branch..."
          git worktree add --detach .pipeline-data-worktree
          cd .pipeline-data-worktree
          git checkout --orphan ${{ inputs.branch_name }}
          git rm -rf . 2>/dev/null || true
          
          echo "# Ignore everything except data directory" > .gitignore
          echo "/*" >> .gitignore
          echo "!data/" >> .gitignore
          echo "!.gitignore" >> .gitignore
          echo "!README.md" >> .gitignore
          echo "" >> .gitignore
          echo "data/db.sqlite" >> .gitignore
          
          echo "# Leaderboard Pipeline Data" > README.md
          echo "This branch contains data files generated by the leaderboard pipeline." >> README.md
          
          git add .gitignore README.md
          git commit -m "Initialize leaderboard pipeline-data branch" || true
          git push -u origin ${{ inputs.branch_name }}
          cd ..
        fi

    - name: Update pipeline-data branch
      if: inputs.operation == 'update'
      shell: bash
      working-directory: apps/leaderboard
      run: |
        set -e
        cd .pipeline-data-worktree
        mkdir -p data
        rsync -av --delete ../${{ inputs.data_dir }}/ data/ --exclude=${{ inputs.exclude_pattern }}
        git add -A data/
        if git diff-index --quiet HEAD; then
          echo "No changes to commit"
        else
          git commit -m "${{ inputs.commit_message }}"
          if ! git push origin HEAD:${{ inputs.branch_name }}; then
            echo "Failed to push normally. Forcing push..."
            git fetch origin ${{ inputs.branch_name }}
            git push --force origin HEAD:${{ inputs.branch_name }}
          fi
        fi
        cd ..

    - name: Cleanup worktree
      if: inputs.operation == 'cleanup'
      shell: bash
      working-directory: apps/leaderboard
      run: git worktree remove .pipeline-data-worktree || true
