# Multi-Repository Summarization Pipeline: Plan

This document outlines the plan to refactor the project summary generation pipeline to support multiple repositories. The new architecture will provide both per-repository and aggregated cross-repository summaries for daily, weekly, and monthly intervals.

## 1. Goals

- Generate daily, weekly, and monthly AI-powered summaries for individual active repositories.
- Generate daily, weekly, and monthly AI-powered "overall" summaries that synthesize activity across all configured repositories.
- Implement a robust, multi-tier pipeline structure that scales with the number of repositories and the volume of activity.
- Enhance the summarization prompts with more detailed context (e.g., PR file changes, issue comments) to improve the quality and accuracy of the output.
- Define clear, structured Markdown formats for each type of summary to ensure consistency and readability.
- Store all generated summaries (both per-repo and overall) for historical analysis and for display in the frontend application.

## 2. Key Architectural Changes

The core of this refactor is a move to a unified, two-tier summarization architecture for all time intervals. This approach ensures a consistent and scalable process, moving away from treating daily summaries differently from weekly or monthly ones.

### 2.1. Tier 1: Per-Repository Summaries

For each time interval (day, week, month), the pipeline will first generate a summary for every repository that had activity during that period.

- **Daily Repo Summaries**: Generated directly from rich, raw activity data from that day, including PR/issue details, file changes, and comments.
- **Weekly & Monthly Repo Summaries**: These are meta-summaries, generated by synthesizing the already-created **daily summaries** from that period. This avoids re-processing raw data and allows the AI to focus on higher-level trends over the week or month.

The pipeline structure for generating these will be:
`generateTimeIntervals(interval) -> mapStep(pipe(getReposWithActivity(interval), mapStep(generateRepoSummary)))`

### 2.2. Tier 2: Overall Project Summaries

After the per-repository summaries for a given interval are created, a second pipeline will generate a single "overall" summary that synthesizes them into a cohesive, project-wide narrative.

- **Daily Overall Summary**: Takes all the daily repo summaries from a given day as input.
- **Weekly & Monthly Overall Summaries**: Take all the weekly or monthly repo summaries from that period as input.

The pipeline structure for this will be:
`pipe(generateTimeIntervals(interval), mapStep(generateOverallSummaryForInterval))`

This two-tier approach ensures that each step in the process is focused and that the context provided to the LLM is always at the appropriate level of abstraction.

## 3. Prompt and Output Format Strategy

To achieve high-quality summaries, we will use tailored prompts and enforce specific output formats for each type of summary.

### 3.1. Daily Repo Summary

- **Prompt Input**: Will include granular details for the day's activity in that repo:
  - List of merged/opened PRs with titles, authors, and **files changed**.
  - List of new/closed issues with titles, authors, and **comment threads**.
  - Other relevant activity like reviews and commits.
- **Output Format**:
  - A single, dense paragraph summarizing the day's key activities.
  - If activity is high, a collapsible "Details" section in Markdown with itemized lists of PRs and issues.

### 3.2. Weekly/Monthly Repo Summary

- **Prompt Input**: The full text of all **daily repo summaries** for the corresponding period.
- **Output Format**:
  - `## Overview`: A single paragraph summarizing the period's achievements and focus.
  - `## Detailed Breakdown`: A structured list of key accomplishments, thematically grouped, similar to the current project summary format.

### 3.3. Daily Overall Summary

- **Prompt Input**: The full text of all **daily repo summaries** from all active repositories for that day.
- **Output Format**:
  - `## Overview`: 2-3 paragraphs providing a cohesive, high-level narrative of progress across the entire project for that day.
  - `## Key Changes`: Formatted details highlighting the most significant PRs, issues, or commits from across all repositories.

### 3.4. Weekly/Monthly Overall Summary

- **Prompt Input**: The full text of all **weekly/monthly repo summaries** from all active repositories for that period.
- **Output Format**:
  - `## Overall Summary`: 2-3 paragraphs providing a strategic overview of the project's progress during the period.
  - `## Repository Highlights`: A section with subsections for the most active or important repositories, detailing their key changes and contributions during the period.

## 4. Detailed Implementation Tasks

### Phase 1: Foundational Refactoring

**Goal:** Reorganize existing code and database schemas to support the new architecture.

- [x] **Task 1.1: Reorganize Pipeline Modules.**
  - Consolidate existing summary logic into a clear structure. Create `aiRepoSummary.ts`, `generateRepoSummary.ts`, `aiOverallSummary.ts`, and `generateOverallSummary.ts` to house the respective logic.
- [x] **Task 1.2: Update Database Schema.**
  - Create a new `overallSummaries` table (`id`, `date`, `intervalType`, `summary`).
  - Generate and apply the database migration.
  - Create mutation functions in `mutations.ts` for storing overall summaries.
- [x] **Task 1.3: Update Filesystem Storage.**
  - Ensure overall summaries can be stored at a root level (e.g., `data/summaries/<intervalType>/<date>.md`). Update `fsHelpers.ts` if needed.

### Phase 2: Implement Per-Repository Summary Pipelines

**Goal:** Build the pipelines for generating summaries for each individual repository.

- [x] **Task 2.1: Implement Daily Repo Summary Pipeline.**
  - Create the `generateDailyRepoSummaries` pipeline as described in the architecture.
  - Create new query functions to fetch the required detailed data (PR files, issue comments).
  - Implement the prompt and Markdown output format as specified.
- [x] **Task 2.2: Implement Weekly/Monthly Repo Summary Pipelines.**
  - Create the `generateWeeklyRepoSummaries` and `generateMonthlyRepoSummaries` pipelines.
  - Implement the logic to fetch the required daily repo summaries from the database to use as input for the prompts.
  - Implement the prompt and Markdown output format as specified.

### Phase 3: Implement Overall Summary Pipelines

**Goal:** Build the pipelines for synthesizing per-repo summaries into project-wide summaries.

- [x] **Task 3.1: Implement Daily Overall Summary Pipeline.**
  - Create the `generateDailyOverallSummary` pipeline.
  - Implement the logic to fetch all daily repo summaries for a given day.
  - Implement the prompt and Markdown output format as specified.
- [x] **Task 3.2: Implement Weekly/Monthly Overall Summary Pipelines.**
  - Create the `generateWeeklyOverallSummary` and `generateMonthlyOverallSummary` pipelines.
  - Implement the logic to fetch all weekly/monthly repo summaries for a given period.
  - Implement the prompt and Markdown output format as specified.

### Phase 4: Integration and Verification

**Goal:** Connect the new pipelines and ensure they work correctly.

- [x] **Task 4.1: Update Main Summarize Pipeline.**
  - In `src/lib/pipelines/summarize/index.ts`, replace the old logic with a new orchestration that correctly sequences the Tier 1 (per-repo) and Tier 2 (overall) summary generations.
- [ ] **Task 4.2: Add Comprehensive Tests.**
  - Write unit tests for the new query functions and prompt generation logic.
  - Write integration tests for the end-to-end pipeline execution.

## 5. Additional Considerations

- **Token Limit Management**: The prompts for weekly/monthly and overall summaries might exceed model context windows. We must implement strategies to handle this, such as truncation, iterative summarization, or using models with larger context windows. This will be a key part of prompt engineering.
- **Error Handling & Dependencies**: The generation of Tier 2 summaries is dependent on the successful completion of Tier 1. The pipeline orchestration must be resilient to failures in individual repo summary generation, deciding whether to proceed with partial data or halt.
- **Cost & Performance**: This new architecture will significantly increase the number of LLM calls. We should monitor costs and performance, and consider optimizations such as caching, parallelization, and using cheaper/faster models for certain tasks where appropriate.

### Phase 5: Refactor Contributor Summaries for Multi-Repository Context

**Goal:** Transition the contributor summary pipeline from a per-repository model to a unified, multi-repository model. This will generate a single summary for each contributor per interval, reflecting all their activity across all tracked repositories.

- [x] **Task 5.1: Verify Contributor Metrics Query.**

  - Review `getContributorMetrics` in `src/lib/pipelines/summarize/queries.ts` to confirm it aggregates a contributor's activity across all repositories. Ensure the data returned includes repository context for each activity item (e.g., PRs, issues).

- [x] **Task 5.2: Enhance Contributor Summary Prompt.**

  - Update `formatContributorPrompt` in `src/lib/pipelines/summarize/aiContributorSummary.ts` to better synthesize and present activities from multiple repositories. Ensure the prompt clearly instructs the AI to group work by repository where it makes sense and provide a holistic view of the contributor's work.

- [x] **Task 5.3: Rework Contributor Summary Generation Pipeline.**

  - In `src/lib/pipelines/summarize/generateContributorSummary.ts`, modify the pipeline logic.
  - The pipeline should no longer be repo-specific. It should get a list of all active contributors across _all_ repositories for a given interval.
  - The `mapStep` should then iterate over the list of unique contributors, not repositories.

- [x] **Task 5.4: Update Top-Level Contributor Pipeline.**
  - In `src/lib/pipelines/summarize/index.ts`, refactor `contributorSummariesPipeline`.
  - Remove the `mapStep` that iterates over selected repositories. The pipeline should be a single flow that generates summaries for all active contributors.
  - This pipeline will now be completely independent of the per-repository logic.
